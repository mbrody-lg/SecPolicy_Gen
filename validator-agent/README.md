# Validator Agent

A review service that validates and improves security policies through multiple rounds of automated checks. Uses multiple specialized validators to ensure compliance, logic, and tone before final approval.

## What It Does

The Validator Agent:
- Receives generated policies from the Policy Agent
- Runs validation checks (compliance, logic, tone) in parallel
- Coordinates multiple rounds of review (up to 3 rounds)
- Identifies issues and provides improvement recommendations
- Requests policy revisions when needed
- Returns final approval or rejection decision

## Key Features

- **Multi-Validator System**: Parallel checks for compliance, logic, and tone
- **Consensus-Based Decisions**: Multiple validators agree before approving
- **Revision Cycles**: Automatically requests improvements up to 3 rounds
- **Detailed Feedback**: Specific reasons and recommendations for changes
- **Full History Tracking**: Stores all validation rounds and decisions

## Prerequisites

- Docker (recommended)
- Python 3.11+ (for local development)
- MongoDB running and accessible
- OpenAI API key
- Policy Agent service accessible

## Environment Variables

Create a `.env` file in the `validator-agent/` directory:

```env
OPENAI_API_KEY=sk-your-key-here
MONGO_URI=mongodb://mongodb:27017/validator-agent-db
FLASK_SECRET_KEY=your-secret-key-here
FLASK_ENV=development
CONFIG_PATH=config/validator-agent.yaml
POLICY_AGENT_URL=http://policy-agent:5000
```

## Running the Service

### With Docker
```bash
make up
```

### Locally
```bash
pip install -r requirements.txt
python run.py
```

The service runs on `http://localhost:5000`

## Configuration

The validation behavior is defined in `config/validator-agent.yaml`:

### Validators Section
Four specialized validators run in parallel each round:

```yaml
roles:
  - name: AWC                    # Compliance Validator
    type: openai
    model: gpt-4o-mini
    temperature: 0.3
    max_tokens: 1000
    instructions: "Check compliance with ISO 27001, GDPR, CIS Controls..."

  - name: AWL                    # Logic Validator
    type: openai
    model: gpt-4o-mini
    temperature: 0.3
    max_tokens: 1000
    instructions: "Verify internal consistency and logical flow..."

  - name: AWT                    # Tone Validator
    type: openai
    model: gpt-4o-mini
    temperature: 0.3
    max_tokens: 1000
    instructions: "Check language clarity, professionalism, and tone..."

  - name: EVA                    # Evaluator (makes final decision)
    type: openai
    model: gpt-4o
    temperature: 0.5
    max_tokens: 1500
    instructions: "Review all validation results and decide: accept/review/reject..."

validation:
  rounds: 3                      # Maximum validation rounds
  consensus_threshold: 2         # How many validators must agree
```

**Validator Roles:**
- **AWC (Compliance)**: Verifies the policy meets all regulatory requirements
- **AWL (Logic)**: Checks for internal consistency and correct structure
- **AWT (Tone)**: Ensures proper language and professional presentation
- **EVA (Evaluator)**: Reviews all feedback and makes final decision

See `config/examples/` for complete configuration examples.

## API Endpoints

### Validate a Policy

```
POST /validate_policy/<context_id>
```

Initiates validation of a policy from the Policy Agent.

- Path parameter: context_id
- Request Body: Optional

        {
            "context_id": "<ObjectId_as_string>",
            "policy_text": "Full text of the policy generated by the Policy-Agent...",
            "structured_plan": "Structured plan obtained by the Policy-Agent...",
            "generated_at": "2025-06-02T18:00:00Z",
            "language": "en",                  // Optional
            "policy_agent_version": "v1.0.0"   // Optional
        }

- Response (200 Ok) [accepted -> context-agent, review | rejected -> policy-agent]:

        {
            "context_id": "<context_id>",
            "language": "en",
            "policy_text": "...",
            "structured_plan": "...",
            "generated_at": "2025-06-02T18:00:00Z",
            "policy_agent_version": "v1.0.0",
            "status": "rejected",                // "accepted", "review" o "rejected"
            "reasons": ["GDPR chapter missing."],
            "recommendations": ["Include GDPR compliance."],
            "evaluator_analysis": {             // Only if additional information exists
                "explanation": "The EVA has detected that a direct reference to GDPR is missing..."
            }
        }

### Get all validations by context

    GET /validation/<context_id>

- Path parameter: context_id (String with ObjectId).
- Answer (200 OK): 

        [
            {
                "_id": "650b8a1e5f4c2a0001d2f3b4",
                "context_id": "642e4f50e9f1a3b2c7d8e9f0",
                "round": 1,
                "results": {
                "AWC": { "result": "accepted", "reasons": [], "recommendations": [] },
                "AWL": { "result": "review", "reasons": ["Inconsistency X."], "recommendations": ["Review Y."] },
                "AWT": { "result": "accepted", "reasons": [], "recommendations": [] },
                "EVA": { "result": "review", "reasons": ["GDPR chapter not found."], "recommendations": ["Add GDPR chapter."] }
                },
                "timestamp": "2025-06-02T18:02:15.123456"
            },
            {
                "_id": "650b8a1e5f4c2a0001d2f3b5",
                "context_id": "642e4f50e9f1a3b2c7d8e9f0",
                "round": 2,
                "results": {
                "AWC": { "result": "rejected", "reasons": ["CIS controls not detailed."], "recommendations": ["Add CIS Controls."] },
                "AWL": { "result": "accepted", "reasons": [], "recommendations": [] },
                "AWT": { "result": "accepted", "reasons": [], "recommendations": [] },
                "EVA": { "result": "accepted", "reasons": [], "recommendations": [] }
                },
                "timestamp": "2025-06-02T18:04:20.654321"
            }
        ]

### Delete all validations from a context (in TESTING mode only)

    DELETE /validation/<context_id>

- Path parameter: context_id.
- Response (200 OK):

      {
      "message": "2 validation(s) deleted for context_id: 642e4f50e9f1a3b2c7d8e9f0"
      }

## Testing

Run the test suite:

```bash
make validator-tests
```

## Development

1. Create a feature branch: `git checkout -b feat/your-feature`
2. Make your changes
3. Add tests for new functionality
4. Run tests: `make validator-tests`
5. Submit a pull request

## Troubleshooting

**Policy Agent Connection Error**
- Ensure Policy Agent is running and accessible at `POLICY_AGENT_URL`
- Check Docker Compose configuration

**MongoDB Connection Error**
- Verify MongoDB is running
- Check `MONGO_URI` in `.env`

**OpenAI API Errors**
- Verify `OPENAI_API_KEY` is correct
- Check you have sufficient API credits
- Confirm model names exist in your API plan

**Validation Not Progressing**
- Check logs with `make logs`
- Verify all validators (AWC, AWL, AWT, EVA) are configured
- Ensure `consensus_threshold` is reasonable (typically 2 out of 4 validators)

## License

MIT License - see [LICENCE.txt](../LICENCE.txt) for details
