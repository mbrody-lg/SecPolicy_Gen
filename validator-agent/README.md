# Validator-Agent

## Project Description
**Validator-Agent** is a Flask-based microservice designed to validate policies generated by the **Policy-Agent**. Its goal is to run several roles (worker agents) to check that the policy meets compliance standards (such as ISO 27001, GDPR, etc.) and improve it if necessary. Up to three rounds of consensus between roles (AWC, AWL, AWT, and EVA) are executed. In case of disagreement or need for revision, the **Validator-Agent** sends a feedback request to the **Policy-Agent**, which updates the policy and restarts the validation process.

### Main Objectives
1. Receive a policy generated by the **Policy-Agent** and validate it in a maximum of 3 rounds.
2. Each round consists of:
   - Validation roles:
     - **AWC** (Agent Worker Compliance): Evaluates regulatory compliance.
     - **AWL** (Agent Worker Logic): Checks the internal consistency of the policy.
     - **AWT** (Agent Worker Tone): Checks for appropriate tone and language.
     - **EVA** (Evaluator): Reviews previous results and decides whether to modify the policy.
   - If any role detects discrepancies, the **Coordinator** requests a new validation cycle after the **Evaluator** issues suggestions.
3. Notify the **Policy-Agent** via an HTTP callback with reasons and recommendations if the policy needs revision or is definitively rejected.
4. Saves the validation history in MongoDB (partial results per round, EVA decisions, timestamps, etc.).

### Prerequisites

1. Docker & Docker Compose (recommended).
2. Python 3.9+ (if running without Docker).
3. Environment variables (outside Docker):

        OPENAI_API_KEY
        MONGO_URI (ex.: mongodb://mongodb:27017/validator-agent-db)
        FLASK_SECRET_KEY
        CONFIG_PATH (path to validator-agent.yaml)
        POLICY_AGENT_URL (base URL of Policy-Agent service, ex.: http://policy-agent:5000)

### Configuration

#### YAML file (validator-agent.yaml)
Review the config/examples/ folder and use what you think is best, be careful! with CONFIG_PATH

- `roles`: List of roles in the order they will be executed. Each role must contain:

            name: Descriptive ID name (AWC, AWL, AWT, EVA).
            type: openai (only OpenAI, Mock-based roles are supported, exceptionally MistralAI only in validator).
            instructions: Textual template for the OpenAI prompt. Can include placeholders for previous answers (for EVA).
            model:  Name of the OpenAI model (e.g. gpt-4o-mini), OpenRouter compatible (e.g. openai/gpt-4o) or MistraAI (e.g. mistral-medium-latest).
            temperature: Float value between 0.0 and 1.0.
            max_tokens: Integer to limit the response.

        max_rounds: Maximum number of validation rounds (typically 3).
        validation:
            rounds: Maximum number of validation rounds (typically 3).
            consensus_threshold: Maximum number of consensus required for acceptance of a policy (typically 2).

### API Usage

#### Initiate Policy Validation

    POST /validate_policy/<context_id>
    Content-Type: application/json

- Path parameter: context_id
- Request Body: Optional

        {
            "context_id": "<ObjectId_as_string>",
            "policy_text": "Full text of the policy generated by the Policy-Agent...",
            "structured_plan": "Structured plan obtained by the Policy-Agent...",
            "generated_at": "2025-06-02T18:00:00Z",
            "language": "en",                  // Optional
            "policy_agent_version": "v1.0.0"   // Optional
        }

- Response (200 Ok) [accepted -> context-agent, review | rejected -> policy-agent]:

        {
            "context_id": "<context_id>",
            "language": "en",
            "policy_text": "...",
            "structured_plan": "...",
            "generated_at": "2025-06-02T18:00:00Z",
            "policy_agent_version": "v1.0.0",
            "status": "rejected",                // "accepted", "review" o "rejected"
            "reasons": ["GDPR chapter missing."],
            "recommendations": ["Include GDPR compliance."],
            "evaluator_analysis": {             // Only if additional information exists
                "explanation": "The EVA has detected that a direct reference to GDPR is missing..."
            }
        }

### Get all validations by context

    GET /validation/<context_id>

- Path parameter: context_id (String with ObjectId).
- Answer (200 OK): 

        [
            {
                "_id": "650b8a1e5f4c2a0001d2f3b4",
                "context_id": "642e4f50e9f1a3b2c7d8e9f0",
                "round": 1,
                "results": {
                "AWC": { "result": "accepted", "reasons": [], "recommendations": [] },
                "AWL": { "result": "review", "reasons": ["Inconsistency X."], "recommendations": ["Review Y."] },
                "AWT": { "result": "accepted", "reasons": [], "recommendations": [] },
                "EVA": { "result": "review", "reasons": ["GDPR chapter not found."], "recommendations": ["Add GDPR chapter."] }
                },
                "timestamp": "2025-06-02T18:02:15.123456"
            },
            {
                "_id": "650b8a1e5f4c2a0001d2f3b5",
                "context_id": "642e4f50e9f1a3b2c7d8e9f0",
                "round": 2,
                "results": {
                "AWC": { "result": "rejected", "reasons": ["CIS controls not detailed."], "recommendations": ["Add CIS Controls."] },
                "AWL": { "result": "accepted", "reasons": [], "recommendations": [] },
                "AWT": { "result": "accepted", "reasons": [], "recommendations": [] },
                "EVA": { "result": "accepted", "reasons": [], "recommendations": [] }
                },
                "timestamp": "2025-06-02T18:04:20.654321"
            }
        ]

### Delete all validations from a context (in TESTING mode only)

    DELETE /validation/<context_id>

- Path parameter: context_id.
- Response (200 OK):

      {
      "message": "2 validation(s) deleted for context_id: 642e4f50e9f1a3b2c7d8e9f0"
      }

### Contribution

1. Create a “fork” of the project.
2. Clone your fork locally.
3. Create a dedicated branch (e.g. feat/new-role-evaluation).
4. Make your changes and run all tests, if you create new features please put a minimum test:
5. Open a “Pull Request” explaining the proposed functionality or fix.

### License

This project is released under the MIT license. See the LICENSE file for more details.
